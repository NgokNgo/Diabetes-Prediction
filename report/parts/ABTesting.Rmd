```{r}
library(ggplot2)
library(dplyr)
library(readr)
library(tidyr)
```

```{r}
df <- read_csv('../data/clean_outliers.csv')
```

```{r}
# kiểm định chi-square với monte carlo simulation
chisq_test <- function(df, var1, var2) {
  observed <- table(df[[var1]], df[[var2]])
  chisq <- chisq.test(observed, simulate.p.value = TRUE, B = 10000)
  return(chisq)
}
```

```{r}
# kiểm định kruskal-wallis
kruskal_test <- function(df, var1, var2) {
  kruskal <- kruskal.test(df[[var1]] ~ df[[var2]], data = df)
  return(kruskal)
}
```

#### Biến giải thích với predictor

```{r}
df_category <- df %>% select(-c('BMI', 'MentHlth', 'PhysHlth', 'Diabetes_012'))

# lấy tên tất cả các cột trong df_category
vars <- colnames(df_category)

chi_square_results <- data.frame(variable = character(), p_value = numeric(), reject = logical(), stringsAsFactors = FALSE)

for (var in vars) {
    chi_square <- chisq_test(df, 'Diabetes_012', var)
    reject <- chi_square$p.value < 0.05
    chi_square_results <- rbind(chi_square_results, data.frame(variable = var, p_value = chi_square$p.value, reject = reject))
}

chi_square_results

```

```{r}
vars_quantitative <- c('BMI', 'PhysHlth', 'MentHlth')

for (var in vars_quantitative) {
   results <- aov(formula=df[[var]] ~ df[['Diabetes_012']], data = df)
   print(summary(results))
}
```

```{r}
for (var in vars_quantitative) {
   results <- kruskal_test(df, var, 'Diabetes_012')
   print(results)
}
```

#### Biến giải thích với nhau

```{r}
df_category <- df %>% select(-BMI, -PhysHlth, -MentHlth)

# chuyển Diabetes_012 xuống cuối cùng
df_category <- df_category %>% select(-Diabetes_012, Diabetes_012)

chi_square_results <- data.frame(variable1 = character(), 
                                variable2 = character(), 
                                No_Diabetes = numeric(),
                                Pre_Diabetes = numeric(),
                                Diabetes = numeric(),
                                reject = logical(), 
                                stringsAsFactors = FALSE)

for (i in 1:(ncol(df_category)-1)) {
    for (j in (i+1):(ncol(df_category)-1)) {
        if (i != j && i != ncol(df_category)-1 && j != ncol(df_category)-1) {
            var1 <- colnames(df_category)[i]
            var2 <- colnames(df_category)[j]
            observes <- table(df_category[[var1]], df_category[[var2]], df_category$Diabetes_012)

            no_diabetes <- chisq.test(observes[,,1],simulate.p.value = TRUE, B = 5000)
            pre_diabetes <- chisq.test(observes[,,2],simulate.p.value = TRUE, B = 5000)
            diabetes <- chisq.test(observes[,,3],simulate.p.value = TRUE, B = 5000)
            if (no_diabetes$p.value < 0.05 && pre_diabetes$p.value < 0.05 && diabetes$p.value < 0.05) {
                reject <- TRUE
            } else {
                reject <- FALSE
            }  

            chi_square_results <- rbind(chi_square_results, data.frame(variable1 = var1, 
                                                                    variable2 = var2, 
                                                                    No_Diabetes = no_diabetes$p.value,
                                                                    Pre_Diabetes = pre_diabetes$p.value,
                                                                    Diabetes = diabetes$p.value, 
                                                                    reject = reject))
        }
    }
}
chi_square_results %>% filter(reject == TRUE)
```

```{r}

chi_square_results %>% filter(reject == FALSE)
```

```{r}
# kruskal-wallis results
kruskal_wallis_results <- data.frame(variable1 = character(), 
                                     variable2 = character(), 
                                     No_Diabetes = numeric(),
                                     Pre_Diabetes = numeric(),
                                     Diabetes = numeric(),
                                     reject = logical(), 
                                     stringsAsFactors = FALSE)

for (var1 in vars_quantitative) {
    for (var2 in vars_quantitative) {
        if (var1 != var2) {
            no_diabetes <- kruskal_test(df %>% filter(Diabetes_012 == 0), var1, var2)
            pre_diabetes <- kruskal_test(df %>% filter(Diabetes_012 == 1), var1, var2)
            diabetes <- kruskal_test(df %>% filter(Diabetes_012 == 2), var1, var2)
            
            if (no_diabetes$p.value < 0.05 && pre_diabetes$p.value < 0.05 && diabetes$p.value < 0.05) {
                reject <- TRUE
            } else {
                reject <- FALSE
            }  

            kruskal_wallis_results <- rbind(kruskal_wallis_results, data.frame(variable1 = var1, 
                                                                              variable2 = var2, 
                                                                              No_Diabetes = no_diabetes$p.value,
                                                                              Pre_Diabetes = pre_diabetes$p.value,
                                                                              Diabetes = diabetes$p.value, 
                                                                              reject = reject))
        }
    }
}

```

```{r}
kruskal_wallis_results
```

### Kết luận

Sau quá trình kiểm định quan hệ giữa các biến, ta có được các nhận xét:
- Tất cả các biến giải thích đều có đóng góp vào mô hình.
- Đa số các biến giải thích có mối quan hệ tương quan, điều này làm mô hình khả năng rất cao bị đa cộng tuyến. Tuy nhiên nếu loại bỏ hết đa cộng tuyến thì giảm hiệu suất mô hình do mâu thuẫn với nhận xét 1. 